#!/usr/bin/env ucode

"use strict";

import * as fs from "fs";
import * as ubus from "ubus";

const method = uc(getenv("REQUEST_METHOD") || "GET"),
  remote_addr = getenv("REMOTE_ADDR") || "",
  stdin = fs.fdopen(0, "r");
let request,
  result = {},
  status;

if (method == "POST" || method == "PUT" || method == "DELETE") {
  try {
    request = json(stdin);
  } catch (error) {
    result.error = `json(): ${error}`;
    status = 422;
  }
  const request_type = type(request);
  if (!result.error && request_type != "object") {
    result.error = `unexpected request type ${request_type}`;
    status = 422;
  }
} else if (method == "GET") {
  request = {};
} else {
  result.error = `unsupported request method: ${method}`;
  status = 404;
}

if (!result.error) {
  const nrequest = {};
  if (method != "GET") {
    nrequest.addr = `${request.addr ?? ""}` || remote_addr;
    if (method == "POST") {
      nrequest.duration = int(request.duration) || 0;
    } else if (method == "PUT") {
      nrequest.timeout = int(request.timeout) || 0;
      nrequest.expires = int(request.expires) || 0;
    }
    if (method == "POST" || method == "PUT") {
      nrequest.comment = `${request.comment ?? ""}`;
    }
  }
  request = nrequest;
}

if (!result.error) {
  const bus = ubus.connect();
  if (bus) {
    if (method == "POST") {
      result = bus.call("sbs", "add_ticket", request);
    } else if (method == "PUT") {
      result = bus.call("sbs", "replace_ticket", request);
    } else if (method == "DELETE") {
      result = bus.call("sbs", "delete_ticket", request);
    } else {
      result = bus.call("sbs", "get_tickets");
    }
    bus.disconnect();
    const result_type = type(result);
    if (result_type != "object") {
      result = { error: `unexpected response type: ${result_type}` };
    }
  } else {
    result.error = ubus.error();
  }
}

if (result.error) {
  if (!status) {
    status = 500;
  }
} else {
  status = 200;
}

// prettier-ignore
const status_message = {
  "200": "OK",
  "404": "Not Found",
  "422": "Unprocessable Entity",
  "500": "Internal Server Error"
}[`${status}`];

print(`Status: ${status} ${status_message}\r\n`);
print("Content-Type: application/json; charset=UTF-8\r\n");
print("\r\n");
print(result);
